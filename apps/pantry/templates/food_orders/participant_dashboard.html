{% extends 'base.html' %}
{% load static %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- Order Window Toast Notification -->
{% if order_window.window_enabled and not can_order %}
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="orderWindowToast" class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
    <div class="toast-header bg-warning text-dark">
      <i class="bi bi-clock-history me-2"></i>
      <strong class="me-auto">Order Window Closed</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body">
      {% if order_window.next_class %}
        <p class="mb-2"><strong>Your next class:</strong><br>
        {{ order_window.next_class|date:"l, F j, Y \a\\t g:i A" }}</p>
        
        {% if order_window.hours_until_open %}
          <p class="mb-2"><strong>Order window opens:</strong><br>
          {{ order_window.window_opens|date:"l, F j, Y \a\\t g:i A" }}</p>
          
          <p class="mb-0 text-muted small">
            <i class="bi bi-hourglass-split"></i> 
            Opens in {{ order_window.hours_until_open|floatformat:0 }} hours
          </p>
        {% else %}
          <p class="mb-2"><strong>Order window closed:</strong><br>
          {{ order_window.window_closes|date:"l, F j, Y \a\\t g:i A" }}</p>
          
          <p class="mb-0 text-muted small">
            Window closed for this class. Check back for your next class.
          </p>
        {% endif %}
      {% else %}
        <p class="mb-0">No program assigned. Please contact your coordinator.</p>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<div class="container py-4">
  <!-- Header + Hamburger -->
    <!-- Hamburger for mobile -->
    <div class="container py-5">
        <div class="text-center mb-4">
          <h2>Welcome, {{ user.first_name|default:user.username }} ðŸ‘‹</h2>
          <p class="text-muted">Here's your current basket summary.</p>
        </div>
      
        <!-- Voucher Balances -->
        <div class="row mb-4">
          <div class="col-md-6">
            <div class="card text-white bg-primary mb-3">
              <div class="card-body">
                <h5 class="card-title">Food Voucher Balance</h5>
                <p class="card-text fs-4">${{ account.available_balance|floatformat:2|default:"NO BALANCE" }}
</p>


              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card text-white bg-warning mb-3">
              <div class="card-body">
                <h5 class="card-title">Hygiene Balance</h5>
                <p class="card-text fs-4">${{ account.hygiene_balance|floatformat:2 }}</p>
                </div> 
                </div>
                <div class="dropdown d-md-none">
      
    </div>

  </div>

  <!-- Participant Info Card -->
  {% if program %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Your Program</h5>
      <p><strong>Program:</strong> {{ program.name }}</p>
      <p><strong>Meeting Day:</strong> {{ program.get_MeetingDay_display }}</p>
      <p><strong>Time:</strong> {{ program.meeting_time|time:"g:i A" }}</p>
      <p><strong>Location:</strong> {{ program.meeting_address }}</p>
    </div>
  </div>
{% endif %}

{% if participant.assigned_coach %}
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Your Life Skills Leader</h5>
      {% load static %}
      <div style="width: 100px; height: 100px; border-radius: 50%; overflow: hidden; background-color: #e9ecef; display: flex; align-items: center; justify-content: center;">
        {% if participant.assigned_coach.image %}
          <img src="{{ participant.assigned_coach.image.url }}" alt="Coach Photo" style="width: 100%; height: 100%; object-fit: cover;">
        {% else %}
          <i class="bi bi-person" style="font-size: 4rem; color: #6c757d;"></i>
        {% endif %}
      </div>
     
      <p><strong>Name:</strong> {{ participant.assigned_coach.name }}</p>
      <p><strong>Email:</strong> <a href="mailto:{{ participant.assigned_coach.email }}">{{ participant.assigned_coach.email }}</a></p>
      <p><strong>Phone:</strong> {{ participant.assigned_coach.phone_number }}</p>
    </div>
  </div>
{% endif %}

  <!-- Orders -->
  <div class="card">
    <div class="card-header">
      Recent Orders
    </div>
    <div class="card-body">
      {% if orders %}
      <ul>
        {% for order in orders %}
        <ul class="list-group">
          <a href="{% url 'order_detail' order.hash %}" class="underline-none text-decoration-none">
          <li class="list-group-item list-group-item-action">
           
              Order #{{ order.id }} - {{ order.created_at|date:"M d, Y" }} - Total: ${{ order.total_price }}
            </li>
            </a>
          </li>
          </ul>
        {% endfor %}
      </ul>
      
      {% else %}
        <p class="text-muted">You haven't placed any orders yet.</p>
      {% endif %}
    </div>
  </div>
   <!-- Navigation -->

    <div class="d-md-block p-3 text-center">
        <form action="{% url 'create_order' %}">
        {% if has_vouchers and can_order %}
         <button type="submit" class="btn btn-success me-2">Place a New Order</button>
        {% else %}
        <button type="submit" class="btn btn-success me-2" disabled 
                {% if not can_order %}
                title="Order window is closed. Check notification above for details."
                {% endif %}>
          Place a New Order
        </button>
        {% endif %}
        </form>
        <a href="{% url 'account_update' %}" class="btn btn-outline-primary me-2">Update Account</a>
        <form action="{% url 'logout' %}" method="post" class="d-inline">
        {% csrf_token %}
          <button type="submit" class="btn btn-outline-danger">Logout</button>
        </form>
      </div>
  </div>
</div>
{% endblock %}
