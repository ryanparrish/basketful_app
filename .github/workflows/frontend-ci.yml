name: Frontend CI/CD - React Containers

on:
  push:
    branches:
      - main
      - develop
    tags:
      - "v*"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "frontend/**"
      - "participant-frontend/**"
      - ".github/workflows/frontend-ci.yml"

jobs:
  frontend-build-check:
    name: Build Check (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: admin
            workdir: frontend
            build_cmd: npm run build
          - name: participant
            workdir: participant-frontend
            build_cmd: npx vite build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ${{ matrix.workdir }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.workdir }}
        run: npm ci

      - name: Build
        working-directory: ${{ matrix.workdir }}
        env:
          VITE_BASE_PATH: ${{ matrix.name == 'admin' && (github.ref == 'refs/heads/develop' && '/new/admin/' || '/admin/') || '/' }}
        run: ${{ matrix.build_cmd }}

  frontend-docker:
    name: Docker Build and Push (${{ matrix.name }})
    runs-on: ubuntu-latest
    needs: frontend-build-check
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/v'))
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: admin
            image_name: basketful-admin
            context: ./frontend
            dockerfile: ./frontend/Dockerfile
          - name: participant
            image_name: basketful-participant
            context: ./participant-frontend
            dockerfile: ./participant-frontend/Dockerfile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/${{ matrix.image_name }}
          tags: |
            type=ref,event=branch,enable=${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
            type=match,pattern=v(.*),group=1,enable=${{ startsWith(github.ref, 'refs/tags/v') }}
            type=sha,format=short,prefix=sha-
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/develop' }}
            type=raw,value=prod-latest,enable=${{ startsWith(github.ref, 'refs/tags/v') }}

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          build-args: |
            VITE_BASE_PATH=${{ matrix.name == 'admin' && (github.ref == 'refs/heads/develop' && '/new/admin/' || '/admin/') || '/' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ matrix.image_name }}:buildcache
          cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/${{ matrix.image_name }}:buildcache,mode=max
